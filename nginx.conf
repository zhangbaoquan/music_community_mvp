user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 1024;
	multi_accept on;
}

http {

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 75s; # Increased for Cloudflare
    keepalive_requests 1000; # Reduce connection churn
    client_header_timeout 20s;
    client_body_timeout 20s;
    send_timeout 20s;
    
	types_hash_max_size 2048;
    client_body_buffer_size 128k;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	##
	# Gzip Settings (From Screenshot)
	##

	gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/wasm application/octet-stream;
    gzip_min_length 1000;

    # Allow large uploads
    client_max_body_size 100M;

	server {
		listen 80 default_server;
		listen [::]:80 default_server;
		server_name qinqinmusic.com www.qinqinmusic.com 62.234.178.73;

		root /var/www/html;
		index index.html index.htm;

        # =========================================================
        # Tencent Cloud CDN Real IP Configuration
        # =========================================================
        # Trust Tencent / Aliyun CDN IPs to get the real client IP.
        # Tencent CDN uses X-Forwarded-For.
        
        # Note: Tencent Cloud IP ranges are vast and dynamic. 
        # For a basic MVP setup, if you are strictly behind the CDN,
        # we configure Real IP via X-Forwarded-For.
        # Alternatively, relying on X-Forwarded-For without strict IP filtering 
        # is sometimes necessary unless using a dynamic script to update ranges.
        # Here we trust internal/common proxy ranges as a fallback, but rely on
        # the CDN correctly appending X-Forwarded-For.
        
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;
        
        # Localhost / Docker internal
        set_real_ip_from 127.0.0.1;
        set_real_ip_from 10.0.0.0/8;
        set_real_ip_from 172.16.0.0/12;
        set_real_ip_from 192.168.0.0/16;

        # =========================================================
        # Supabase Proxy (Fixed Image Loading + API)
        # =========================================================
        
        # [Critical Fix] CORS Handling for Cloudflare Flexible SSL
        # We handle CORS here to avoid protocol mismatch issues with Supabase Kong

        location ^~ /storage/v1/ {
            # Handle Preflight
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,apikey,x-client-info' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            proxy_pass http://127.0.0.1:8000/storage/v1/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # Add Headers for actual requests
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,apikey,x-client-info' always;
            # Hide upstream CORS to prevent duplicates
            proxy_hide_header Access-Control-Allow-Origin;
        }

        location ^~ /auth/v1/ {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,apikey,x-client-info' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            proxy_pass http://127.0.0.1:8000/auth/v1/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,apikey,x-client-info' always;
            proxy_hide_header Access-Control-Allow-Origin;
        }

        location ^~ /rest/v1/ {
             if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,apikey,x-client-info,Prefer' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            proxy_pass http://127.0.0.1:8000/rest/v1/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,apikey,x-client-info,Prefer' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Range,X-Total-Count' always;
            proxy_hide_header Access-Control-Allow-Origin;
        }

        location ^~ /realtime/v1/ {
            proxy_pass http://127.0.0.1:8000/realtime/v1/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            # Realtime usually handles its own CORS via WebSocket handshake, but let's be safe
            proxy_set_header Origin ""; 
        }

        # =========================================================
        # Caching Strategy (Enhanced from Screenshot)
        # =========================================================

        # 1. index.html - "Always" for cache Headers
        location = /index.html {
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            expires -1;
            try_files $uri $uri/ =404;
        }

        # 2. Bootstrapping files
        location ~* (flutter_service_worker\.js|flutter_bootstrap\.js|version\.json) {
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            expires -1;
        }

        # 3. main.dart.js (App Logic)
        location ~* main\.dart\.js$ {
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            expires -1;
        }

        # 4. Static Assets (Cache 30d)
        location ~* \.(jpg|jpeg|png|gif|ico|css|woff|woff2|ttf|svg|eot|otf|wasm)$ {
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }

        # =========================================================
        # Main Route
        # =========================================================
		location / {
			try_files $uri $uri/ /index.html;
            
            # Double insurance for no-cache on SPA roots
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
		}
	}
}

# 亲亲心情笔记 (Music Community MVP) 技术设计与实现方案

## 1. 项目概述
“亲亲心情笔记”是一个以“音乐+心情日记”为核心体验的轻量级社交社区。项目的核心目标在于快速验证市场需求，为单兵作战（独立开发者）提供一条从想法到上线的标准 MVP（最小可行性产品）路径。未来该架构也可无缝复用至移动端（iOS / Android）的开发中。

## 2. 前端架构与技术选型

### 2.1 核心框架
*   **技术栈：** Flutter Web (Dart)
*   **选型考量：** 具备跨端复用的巨大势能。统一的 Canvas 渲染引擎能够保证不同浏览器终端上高度一致的 UI 表现；一套代码即可在未来以极低成本横向扩展至 App 端，最大化独立开发者的产能。

### 2.2 状态管理与路由
*   **技术栈：** GetX
*   **选型考量：** GetX 提供了轻量且极具生产力的响应式状态管理（Rx）、依赖注入和路由管理机制。能够以极简的样板代码实现视图与业务逻辑的分离（Controller 层），非常适合需要快速迭代的 MVP 项目。

### 2.3 核心功能组件实现
*   **富文本与内容创作：** 引入 `flutter_quill` 作为核心编辑器，配合本地化支持，深度定制了图文混排的心情日记/文章编辑体验。
*   **媒体音频播放控制：** 基于全局共享状态注入播放器控制器（`PlayerController`），实现跨页面的音乐连续播放、状态监听与响应式 UI 更新。
*   **响应式布局系统：** 依托 `LayoutBuilder` 和多屏媒体查询构建了弹性的 Adaptive Layout 架构，无缝兼容 Desktop 宽屏与 Mobile 竖屏设备的交互特性。
*   **游戏化激励系统：** 设计并实现了基于成就条件的 Badge（微章）系统引擎模块。

### 2.4 Web 端深度重构与专项优化
针对 Flutter Web 原生体验痛点，进行了深度定制：
*   **首屏白屏优化（极致过渡）：** 在原始 `index.html` 注入了极简的 CSS Loading 动画层；使用 `dart:js` 互操作机制，在首帧渲染准备完毕的精确钩子点（`WidgetsBinding.addPostFrameCallback`）安全销毁 JS 层的 Loading 遮罩，实现顺滑且无视觉塌陷的首屏衔接。
*   **Service Worker 策略：** 考虑到强依赖缓存导致的版本迭代延迟问题，移除了默认的 PWA Service Worker 离线逻辑，采用传统的基于版本号清缓存策略。
*   **字体加载策略优化：** 弃用大规模外部网络中文字体文件的静默加载，转而使用系统级安全中文字体栈作为核心备选字体，极大加快了文字的渲染展现速度（FCP）。

---

## 3. 后端方案与数据服务

为了避免独立开发者陷入繁重的后端 CRUD 与运维沼泽，本作采取了 Serverless / BaaS 的灵活架构模式。

### 3.1 核心云平台 (BaaS)
*   **技术栈：** Supabase (PostgreSQL 构建的开源 Firebase 替代品)
*   **选型考量：** 提供开箱即用的 Auth（鉴权系统）、高性能关系型数据库、API 自动生成器，以及 S3 兼容的对象存储引擎。同时内置的 Realtime 引擎完美覆盖了社区互动需求。

### 3.2 抽象数据建模设计 (PostgreSQL)
构建了关系严密且权限边界分明的数据宽表基底：
*   `profiles`：用户元数据库，集成基础画像、角色权限鉴别及风控封禁（`banned_until`）等底层属性。
*   `mood_diaries` / `articles`：贯穿始终的内容载体表，基于关联键链接用户资产。
*   `songs` / `music`：维系平台用户原创音频资产的核心库。
*   **社交拓扑矩阵：** 拆分并建立了 `comments`（层级评论）、`follows`（关注图谱）、`article_likes` 和 `profile_visits`（访客流水）等微结构表。

### 3.3 实时通信流水线 (Realtime)
*   使用 Supabase Realtime Channel (WebSocket) 订阅评论区等高频交互界面的数据流。规避了传统后端手写 Socket 鉴权与心跳包断线重连的问题，极大缩减了开发时效。

### 3.4 资产安全存储引擎 (Storage)
*   采用 Supabase Storage Bucket 切片存放多媒体数据（头像、封面缩略图、音乐介质）。
*   配置 Row Level Security (RLS) 策略矩阵，实行严格的读写物理鉴权隔离。

---

## 4. 生产环境架构与运维拓扑

随着对业务性能（尤其是国内下沉网络环境）理解的深入，网络层经受了大规模的架构演变与重写。

### 4.1 原始环境基建
*   **节点与操作系统：** 中国北京 BGP 多线高可用计算节点硬件，系统基座采用 Linux。
*   **Web Server (Nginx) 核心调度：**
    *   **SPA 单页应用穿透：** `try_files $uri $uri/ /index.html;` 控制引擎将深层 URL 指令回退给 Flutter Router。
    *   **极端缓存提速：** 使用 Nginx 对 `.js, .wasm, .png` 静态打包源释放 `expires 30d` 的强制缓存信标。

### 4.2 Web 攻击防护与流量整形 (Nginx Hardening)
在 Nginx 层编排了针对 MVP 抗压的基础安全防护阵列：
*   加载并启动了 `limit_req_zone` 进行 IP 频控管理，抵御基础性的接口恶意抓取和爆破攻击。
*   加载并启动了 `limit_conn_zone` 限制同一源的 TCP 幽灵连接饱和攻击。
*   在 Http 报文中注入了 User-Agent 黑名单机制，拦截知名自动扫描爬虫。

### 4.3 边缘网络加速与回源链路演进方案
*   **阶段一尝试（Cloudflare）：** 顶层设计为 DNS + Cloudflare (代理与 SSL 卸载) + Origin 服务器。
    *   *遭遇瓶颈：* 因 Cloudflare 海外非企业版节点长期受到国际互联网骨干线路封锁的干扰（GFW 随机阻断机制），大量出现 SSL Handshake 未知终止导致 `ERR_CONNECTION_CLOSED` 及反复白屏重连事件。国内终端用户可用性受到严重破坏。
*   **阶段二落地（国内头部 CDN 架构迁移 —— 最终重构方案）：**
    *   **解析扁平化与剥离：** Cloudflare 仅保留底层 DNS 调度权威解析服务，停止其网关代理层（关闭橙色云）。使用 Cloudflare 提供的 CNAME Flattening 高级特性，合法地将根域名 `@` CNAME 到复杂的第三方网关池。
    *   **就近边缘计算节点接入：** 启用了国内**腾讯云 CDN**进行全国全链路节点内容加速与分发 (`dnsv1.com`)。从根本物理层面上清除了跨境数据包丢失及大延迟带来的握手崩溃。
    *   **HTTPS 零成本前置卸载：** 使用腾讯云控制台内置流程直接申请 TrustAsia (Digicert) 免费通配版 SSL 证书并部署于 CDN 流量入口侧。
    *   **网络源真实性反穿透 (Origin Real-IP Bypass)：** 重写 Nginx `set_real_ip_from` 白名单配置块。清空海外网关名单。基于腾讯云提供的 `X-Forwarded-For` 将请求追踪链提取能力赋予 Nginx 上游，确保社区后台用户行为抓取的溯源精确无误。

---

## 5. 项目工程化与 CI/CD 自动化流水线
放弃了臃肿的 Jenkins / GitHub Action，出于极客美学采用了极小型 Shell 交付流程驱动持续集成机制。

*   **业务产物交付脚本 (`deploy.sh`)：** 封装了 `flutter build web`，并将本地编译最终 `build/web/` 的静态文件资源体，通过 `rsync` 差量同步算法推流覆盖至北京产线集群的工作母目录中。
*   **网关配置平滑同步 (`deploy_nginx.sh`)：** 执行本地配置到服务端的推流。使用命令集依次实行 `nginx -t` 进行结构树安全与语法合规检验，检测通过后才向物理机身发送 `nginx -s reload` 系统信号，保障产线架构更新做到**零宕机**平躺。
